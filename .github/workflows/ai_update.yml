# AIæ°—è±¡ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒ¼ å®šæœŸæ›´æ–°ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# 1æ—¥5å›žï¼ˆJST 7æ™‚, 10æ™‚, 13æ™‚, 17æ™‚, 21æ™‚ï¼‰å®Ÿè¡Œ

name: AI Weather Advisor Update

on:
  schedule:
    # UTCæ™‚é–“ã§è¨­å®šï¼ˆJST = UTC + 9ï¼‰
    # JST 7:00 = UTC 22:00 (å‰æ—¥)
    # JST 10:00 = UTC 01:00
    # JST 13:00 = UTC 04:00
    # JST 17:00 = UTC 08:00
    # JST 21:00 = UTC 12:00
    - cron: '0 22 * * *'  # JST 7:00
    - cron: '0 1 * * *'   # JST 10:00
    - cron: '0 4 * * *'   # JST 13:00
    - cron: '0 8 * * *'   # JST 17:00
    - cron: '0 12 * * *'  # JST 21:00
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ai-advisor-update
  cancel-in-progress: false

# æ¨©é™è¨­å®šï¼ˆãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿ã‚’æ˜Žç¤ºçš„ã«è¨±å¯ï¼‰
permissions:
  contents: write

jobs:
  update-ai-comment:
    runs-on: ubuntu-latest
    
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ5åˆ†ï¼‰
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Backup previous ai_comment.json
        run: |
          if [ -f ai_comment.json ]; then
            cp ai_comment.json ai_comment.backup.json
            echo "Backup created"
          else
            echo "No previous ai_comment.json to backup"
          fi
      
      - name: Run AI Advisor Script
        id: run_script
        env:
          # GitHub Secretsã‹ã‚‰å®‰å…¨ã«APIã‚­ãƒ¼ã‚’èª­ã¿è¾¼ã¿
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: |
          python scripts/ai_advisor.py
        continue-on-error: true
      
      - name: Verify output and handle errors
        run: |
          if [ -f ai_comment.json ]; then
            # JSONãŒæœ‰åŠ¹ã‹ç¢ºèª
            if python -c "import json; json.load(open('ai_comment.json'))" 2>/dev/null; then
              echo "âœ… ai_comment.json is valid"
              
              # adviceãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
              if python -c "import json; data=json.load(open('ai_comment.json')); assert data.get('advice') and len(data['advice']) > 10" 2>/dev/null; then
                echo "âœ… Advice content is valid"
              else
                echo "âš ï¸ Advice content is missing or too short, restoring backup"
                if [ -f ai_comment.backup.json ]; then
                  cp ai_comment.backup.json ai_comment.json
                fi
              fi
            else
              echo "âš ï¸ Invalid JSON, restoring backup"
              if [ -f ai_comment.backup.json ]; then
                cp ai_comment.backup.json ai_comment.json
              fi
            fi
          else
            echo "âš ï¸ ai_comment.json not created, restoring backup"
            if [ -f ai_comment.backup.json ]; then
              cp ai_comment.backup.json ai_comment.json
            fi
          fi
      
      - name: Cleanup backup
        run: |
          rm -f ai_comment.backup.json
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
          if git diff --quiet ai_comment.json 2>/dev/null; then
            echo "No changes to commit"
          else
            git add ai_comment.json
            git commit -m "ðŸ¤– Update AI weather advice [$(date +'%Y-%m-%d %H:%M JST')]"
            git pull --rebase origin main || true
            git push
            echo "âœ… Changes pushed successfully"
          fi
